<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>Snakemake for Lattice Quantum Field Theory: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="assets/styles.css">
<script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="favicons/incubator/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicons/incubator/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicons/incubator/favicon-16x16.png">
<link rel="manifest" href="favicons/incubator/site.webmanifest">
<link rel="mask-icon" href="favicons/incubator/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="white">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="black">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Lesson Description" src="assets/images/incubator-logo.svg"><span class="badge text-bg-danger">
          <abbr title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.">
            <a href="https://docs.carpentries.org/resources/curriculum/lesson-life-cycle.html" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
              Pre-Alpha
            </a>
            <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text">
<li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul>
</li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/aio.html';">Instructor View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Lesson Description" src="assets/images/incubator-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      Snakemake for Lattice Quantum Field Theory
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            Snakemake for Lattice Quantum Field Theory
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
<li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul>
</li>
      </ul>
</div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Snakemake for Lattice Quantum Field Theory
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text">
<li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul>
</li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/aio.html">Instructor View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->

            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="introduction.html">1. Running commands with Snakemake</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="python.html">2. Running Python code with Snakemake</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="placeholders.html">3. Placeholders and wildcards</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="chaining.html">4. Chaining rules</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="parameters.html">5. Metadata and parameters</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="multiple.html">6. Multiple inputs and outputs</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="dag.html">7. How Snakemake plans jobs</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="optimisation.html">8. Optimising workflow performance</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="reference.html">Reference</a></li>
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources">
<a href="aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">

            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-introduction"><p>Content from <a href="introduction.html">Running commands with Snakemake</a></p>
<hr>
<p>Last updated on 2025-05-20 |

        <a href="https://github.com/edbennett/snakemake-novice-lattice/edit/main/episodes/introduction.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I run a simple command with Snakemake?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Create a Snakemake recipe (a Snakefile)</li>
<li>Use Snakemake to compute the average plaquette of an ensemble</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<hr class="half-width">
<p>Data analysis in lattice quantum field theory generally has many
moving parts: you will likely have many ensembles, with differing
physical and algorithmic parameters, and for each many different
observables may be computed. These need to be combined in different
ways, making sure that compatible statistics are used. Making sure that
each step runs in the correct order is non-trivial, requiring careful
bookkeeping, especially if we want to update data as ensembles are
extended, if we want to take advantage of parallelism to get results
faster, and if we want auditability to be able to verify later what
steps were performed.</p>
<p>While we could build up tools to do all of these things from scratch,
these are not challenges exclusive to lattice, and so we can take
advantage of others’ work rather than reinventing the wheel. This frees
up our time to focus on the physics challenges. The category of “tools
to help run complex arrangements of tools in the right order” is called
“workflow management”; there are workflow managers available, most of
which are specialised to a specific class of applications.</p>
<p>One workflow manager developed for scientific data analysis is called
Snakemake; this will be the target of this lesson. Snakemake is similar
to <a href="https://www.gnu.org/software/make/" class="external-link">GNU Make</a>, in that
you create a text file containing rules specifying how input files are
translated to output files, and then the software will work out what
rules to run to generate a specified output from the available input
files. Unlike Make, Snakemake uses a syntax closely based on Python, and
files containing rules can be extended using standard Python syntax. It
also has many quality-of-life improvements compared to Make, and so is
much better suited for writing data analysis workflows.</p>
<p>At this point, you should have Snakemake already installed and
available to you. To test this, we can open a terminal and run</p>
<pre class="shellsession"><code>$ snakemake --version
8.25.3</code></pre>
<p>If you instead get a “command not found” error, go back to the <a href="index.html#setup">setup</a> and check that you have completed all the
necessary steps.</p>
</section><section><h2 class="section-heading" id="looking-at-the-sample-data">Looking at the sample data<a class="anchor" aria-label="anchor" href="#looking-at-the-sample-data"></a>
</h2>
<hr class="half-width">
<p>You should already have the sample data files unpacked. (If not,
refer back to the <a href="index.html#setup">lesson setup</a>.) Under the
<code>su2pg/raw_data</code> directory, you will find a series of
subdirectories, each containing data for a single ensemble. In each are
files containing the log of the configuration generation, the
computation of the quenched meson spectrum, and the computation of the
<a href="https://doi.org/10.48550/arXiv.1006.4518" class="external-link">Wilson flow</a>.</p>
<p>The sample data are for the SU(2) pure Yang-Mills theory, and have
been generated using the <a href="https://github.com/claudiopica/HiRep" class="external-link">HiRep</a> code.</p>
<p>Each log contains header lines describing the setup, information on
the computation being computed, and results for observables computed on
each configuration. Code to parse these logs and compute statistics is
included with the sample data; we’ll use these in due course</p>
</section><section><h2 class="section-heading" id="making-a-snakefile">Making a Snakefile<a class="anchor" aria-label="anchor" href="#making-a-snakefile"></a>
</h2>
<hr class="half-width">
<p>To start with, let’s define a rule to count the number of lines in
one of the raw data files.</p>
<p>Within the <code>su2pg/workflow</code> directory, edit a new text
file named <code>Snakefile</code>. Into it, insert the following
content:</p>
<pre class="snakemake"><code>rule count_lines:
    input: "raw_data/beta4.0/out_pg"
    output: "intermediary_data/beta4.0/pg.count"
    shell:
        "wc -l raw_data/beta4.0/out_pg &gt; intermediary_data/beta4.0/pg.count"</code></pre>
<div id="key-points-about-this-file" class="callout checklist">
<div class="callout-square">
<i class="callout-icon" data-feather="check-square"></i>
</div>
<div id="key-points-about-this-file" class="callout-inner">
<h3 class="callout-title">Key points about this file</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li>The file is named <code>Snakefile</code> - with a capital
<code>S</code> and no file extension.</li>
<li>Some lines are indented. Indents must be with space characters, not
tabs.</li>
<li>The rule definition starts with the keyword <code>rule</code>
followed by the rule name, then a colon.</li>
<li>We named the rule <code>count_trajectories</code>. You may use
letters, numbers or underscores, but the rule name must begin with a
letter and may not be a keyword.</li>
<li>The keywords <code>input</code>, <code>output</code>,
<code>shell</code> are all followed by a colon.</li>
<li>The file names and the shell command are all in
<code>"quotes"</code>.</li>
</ol>
</div>
</div>
</div>
<p>The first line tells Snakemake we are defining a new rule. Subsequent
indented lines form a part of this rule; while there are none here, any
subsequent unindented lines would not be included in the rule. The
<code>input:</code> line tells Snakemake what files to look for to be
able to run this rule. If this file is missing (and there is no rule to
create it), Snakemake will not consider running this rule. The
<code>output:</code> line tells Snakemake what files to expect the rule
to generate. If this file is not generated, then Snakemake will abort
the workflow with an error. Finally, the <code>shell:</code> block tells
Snakemake what shell commands to run to get the specified output from
the given input.</p>
<p>Going back to the shell now, we can test this rule. From the
<code>su2pg</code> directory, we can run the command</p>
<pre class="shellsession"><code>snakemake --jobs 1 --forceall --printshellcmds intermediary_data/beta4.0/pg.count</code></pre>
<p>If we’ve made any transcription errors in the rule (missing quotes,
bad indentations, etc.), then it will become clear at this point, as
we’ll receive an error that we will need to fix.</p>
<p>For now, we will consistently run <code>snakemake</code> with the
<code>--jobs 1 --forceall --printshellcmds</code> options. As we move
through the lesson, we’ll explain in more detail when we need to modify
them.</p>
<p>Let’s check that the output was correctly generated:</p>
<pre class="shellsession"><code>$ cat intermediary_data/beta4.0/pg.count
  31064 raw_data/beta4.0/out_pg</code></pre>
<div id="callout1" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>You might have noticed that we are grouping files into directories
like <code>raw_data</code> and <code>intermediary_data</code>. It is
generally a good idea to keep raw input data separate from data
generated by the analysis. This means that if you need to run a clean
analysis starting from your input data, then it is much easier to know
what to remove and what to keep. Ideally, the <code>raw_data</code>
directory should be kept read-only, so that you don’t accidentally
modify your input data. Similarly, it is a good idea to separate out
“files that you want to include in a paper” from “intermediary files
generated by the workflow but not needed in the paper”; we’ll talk more
about that in a later section.</p>
<p>You might also worry that your tooling will need to use
<code>mkdir</code> to create these directories; in fact, Snakemake will
automatically create all directories where it expects to see output from
rules that it runs.</p>
</div>
</div>
</div>

<div id="running-snakemake" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="running-snakemake" class="callout-inner">
<h3 class="callout-title">Running Snakemake</h3>
<div class="callout-content">
<p>Run <code>snakemake --help | less</code> to see the help for all
available options. What does the <code>--printshellcmds</code> option in
the <code>snakemake</code> command above do?</p>
<ol style="list-style-type: decimal">
<li>Protects existing output files</li>
<li>Prints the shell commands that are being run to the terminal</li>
<li>Tells Snakemake to only run one process at a time</li>
<li>Prompts the user for the correct input file</li>
</ol>
<p><em>Hint: you can search in the text by pressing <code>/</code>, and
quit back to the shell with <code>q</code></em></p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<ol start="2" style="list-style-type: decimal">
<li>Prints the shell commands that are being run to the terminal</li>
</ol>
<p>This is such a useful thing we don’t know why it isn’t the default!
The <code>--jobs 1</code> option is what tells Snakemake to only run one
process at a time, and we’ll stick with this for now as it makes things
simpler. The <code>--forceall</code> option tells Snakemake to always
recreate output files, and we’ll learn about protected outputs much
later in the course. Answer 4 is a total red herring, as Snakemake never
prompts interactively for user input.</p>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="counting-trajectories">Counting trajectories<a class="anchor" aria-label="anchor" href="#counting-trajectories"></a>
</h2>
<hr class="half-width">
<p>The count of output lines isn’t particularly useful. Potentially more
interesting is the number of trajectories in a given file. In a HiRep
generation log, each trajectory concludes with a line of the form</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[MAIN][0]Trajectory #1: generated in [39.717707 sec]</code></pre>
</div>
<p>We can use <code>grep</code> to count these, as</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">grep</span> <span class="at">-c</span> generated raw_data/beta4.0/out_pg</span></code></pre>
</div>
<div id="counting-sequences-in-snakemake" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="counting-sequences-in-snakemake" class="callout-inner">
<h3 class="callout-title">Counting sequences in Snakemake</h3>
<div class="callout-content">
<p>Modify the Snakefile to count the number of
<strong>trajectories</strong> in <code>raw_data/beta4.0/out_pg</code>,
rather than the number of <strong>lines</strong>.</p>
<ul>
<li>Rename the rule to <code>count_trajectories</code>
</li>
<li>Keep the output file name the same</li>
<li>Remember that the result needs to go into the output file, not just
be printed on the screen</li>
<li>Test the new rule once it is done.</li>
</ul>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<pre class="snakemake"><code>rule count_trajectories:
    input: "raw_data/beta4.0/out_pg"
    output: "intermediary_data/beta4.0/pg.count"
    shell:
        "grep -c generated raw_data/beta4.0/out_pg &gt; intermediary_data/beta4.0/pg.count"</code></pre>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Before running Snakemake you need to write a Snakefile</li>
<li>A Snakefile is a text file which defines a list of rules</li>
<li>Rules have inputs, outputs, and shell commands to be run</li>
<li>You tell Snakemake what file to make and it will run the shell
command defined in the appropriate rule</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-python"><p>Content from <a href="python.html">Running Python code with Snakemake</a></p>
<hr>
<p>Last updated on 2025-05-20 |

        <a href="https://github.com/edbennett/snakemake-novice-lattice/edit/main/episodes/python.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I configure an environment to run Python with Snakemake?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Create a Conda environment definition</li>
<li>Use Snakemake to instantiate this environment and use it to run
Python code</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="why-define-an-environment">Why define an environment<a class="anchor" aria-label="anchor" href="#why-define-an-environment"></a>
</h2>
<hr class="half-width">
<p>Snakemake is written in Python, so anyone running a Snakemake
workflow already has Python available. In principle, we could make use
of this installation to run any Python code we need to run in our
workflow. However, it’s more than likely we will need to make use of
libraries that are not installed as part of the Snakemake installation.
At that point, we would either need to install additional libraries into
our Snakemake environment, which might be used by other analyses that
need their own sets of libraries that could create conflicts, or to
create a second Snakemake environment for this analysis. If different
steps of our workflow need different, conflicting sets of libraries then
this becomes more complicated again.</p>
<p>We would also like those trying to reproduce our work to be able to
run using exactly the same software environment that we used in our
original work. In principle, we could write detailed documentation
specifying which packages to install; however, it is both more precise
and more convenient to define the environment as a data file, which
Conda can use to build the same environment every time.</p>
<p>Even better, we can tell Snakemake to use a specific Conda
environment for each rule we define.</p>
</section><section><h2 class="section-heading" id="a-basic-environment-definition">A basic environment definition<a class="anchor" aria-label="anchor" href="#a-basic-environment-definition"></a>
</h2>
<hr class="half-width">
<p>Conda environment definitions are created in <a href="https://yaml.org" class="external-link">YAML</a>-format files. These specify what Conda
packages are needed (including the target version of Python), as well as
any Pip packages that are installed.</p>
<div id="callout1" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>Some packages give you a choice as to whether to install using Conda
or Pip. When working interactively with an environment, using Pip
consistently typically reduces the chance of getting into a state where
Conda is unable to install packages. That is less of a problem when
constructing new environments from definition files, but even so, using
Pip where possible will typically allow environments to resolve and
install more quickly.</p>
</div>
</div>
</div>
<p>By convention, Conda environment definitions in Snakemake workflows
are placed in a <code>workflow/envs/</code> directory. Let’s create
<code>workflow/envs/analysis.yml</code> now, and place the following
content into it</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> su2pg_analysis</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">channels</span><span class="kw">:</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> conda-forge</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> pip=24.2</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> python=3.12.6</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">pip</span><span class="kw">:</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> h5py==3.11.0</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> matplotlib==3.9.2</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> numpy==2.1.1</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> pandas==2.2.3</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> scipy==1.14.1</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> uncertainties==3.2.2</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> corrfitter==8.2</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> -e ../../libs/su2pg_analysis</span></span></code></pre>
</div>
<p>This will install the specified versions of h5py, Matplotlib, Numpy,
Pandas, Scipy, uncertainties, and corrfitter, as well as the analysis
tools provided in the <code>libs</code> directory. The latter are
installed in editable mode, so if you need to modify them to fix bugs or
add functionality while working on your workflow, you don’t need to
remember to manually reinstall them.</p>
</section><section><h2 class="section-heading" id="using-an-environment-definition-in-a-snakefile">Using an environment definition in a Snakefile<a class="anchor" aria-label="anchor" href="#using-an-environment-definition-in-a-snakefile"></a>
</h2>
<hr class="half-width">
<p>Now that we have created an environment file, we can use it in our
Snakefile to compute the average plaquette from a configuration
generation log. Let’s add the following rule to
<code>envs/Snakefile</code>:</p>
<pre class="snakemake"><code>rule avg_plaquette:
    input: "raw_data/beta4.0/out_pg"
    output: "intermediary_data/beta4.0/pg.plaquette.json.gz"
    conda: "envs/analysis.yml"
    shell:
        "python -m su2pg_analysis.plaquette raw_data/beta4.0/out_pg --output_file intermediary_data/beta4.0/pg.plaquette.json.gz"</code></pre>
<p>The <code>conda:</code> block tells Snakemake where to find the Conda
environment that should be used for running this rule. Let’s test this
now:</p>
<pre class="shellsession"><code>snakemake --jobs 1 --forceall --printshellcmds --use-conda intermediary_data/beta4.0/pg.plaquette.json.gz</code></pre>
<p>We need to specify <code>--use-conda</code> to tell Snakemake to pay
attention to the <code>conda:</code> specification.</p>
<p>Let’s check now that the output was correctly generated:</p>
<pre class="shellsession"><code>$ cat intermediary_data/beta4.0/pg.plaquette.json.gz | gunzip | head -n 20
{
 "program": "pyerrors 2.11.0",
 "version": "1.1",
 "who": "ed",
 "date": "2025-02-20 14:59:00 +0000",
 "host": "tsukasa.local, macOS-15.3.1-arm64-arm-64bit",
 "description": {
  "group_family": "SU",
  "num_colors": 2,
  "nt": 48,
  "nx": 24,
  "ny": 24,
  "nz": 24,
  "beta": 4.0,
  "num_heatbath": 1,
  "num_overrelaxed": 4,
  "num_thermalization": 1000,
  "thermalization_time": 2594.755651
 },
 "obsdata": [{</code></pre>
<p>Some of the output will differ on your machine, since this library
tracks provenance, such as where and when the code was run, in the
output file.</p>
<div id="more-plaquettes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="more-plaquettes" class="callout-inner">
<h3 class="callout-title">More plaquettes</h3>
<div class="callout-content">
<p>Add a second rule to compute the average plaquette in the file
<code>intermediary_data/beta4.5/out_pg</code>. Add this to the same
Snakefile you already made, under the <code>avg_plaquette</code> rule,
and run your rules in the terminal. When running the
<code>snakemake</code> command you’ll need to tell Snakemake to make
both the output files.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>You can choose whatever name you like for this second rule, but it
can’t be <code>avg_plaquette</code>, as rule names need to be unique
within a Snakefile. So in this example answer we use
<code>avg_plaquette2</code>.</p>
<pre class="snakemake"><code>rule avg_plaquette2:
    input: "raw_data/beta4.5/out_pg"
    output: "intermediary_data/beta4.5/pg.plaquette.json.gz"
    conda: "envs/analysis.yml"
    shell:
        "python -m su2pg_analysis.plaquette raw_data/beta4.5/out_pg --output_file intermediary_data/beta4.5/pg.plaquette.json.gz"</code></pre>
<p>Then in the shell:</p>
<pre class="shellsession"><code>snakemake --jobs 1 --forceall --printshellcmds --use-conda intermediary_data/beta4.0/pg.plaquette.json intermediary_data/beta4.5/pg.plaquette.json</code></pre>
<p>If you think writing a separate rule for each output file is silly,
you are correct. We’ll address this next!</p>
</div>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-placeholders"><p>Content from <a href="placeholders.html">Placeholders and wildcards</a></p>
<hr>
<p>Last updated on 2025-05-20 |

        <a href="https://github.com/edbennett/snakemake-novice-lattice/edit/main/episodes/placeholders.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I make a generic rule?</li>
<li>How does Snakemake decide what rule to run?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Use Snakemake to compute the plaquette in any file</li>
<li>Understand the basic steps Snakemake goes through when running a
workflow</li>
<li>See how Snakemake deals with some errors</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="making-rules-more-generic">Making rules more generic<a class="anchor" aria-label="anchor" href="#making-rules-more-generic"></a>
</h2>
<hr class="half-width">
<p>In the previous two episodes, we wrote rules to count the number of
generated trajectories in, and compute the average plaquette of, one
ensemble. As a reminder, this was one such rule:</p>
<pre class="snakemake"><code>rule count_trajectories:
    input: "raw_data/beta4.0/out_pg"
    output: "intermediary_data/beta4.0/pg.count"
    shell:
        "grep -c generated raw_data/beta4.0/out_pg &gt; intermediary_data/beta4.0/pg.count"</code></pre>
<p>When we needed to do the same for a second ensemble, we made a second
copy of the rule, and changed the input and output filenames. This is
obviously not scalable to large analyses: instead, we would like to
write one rule for each type of operation we are interested in. To do
this, we’ll need to use <strong>placeholders</strong> and
<strong>wildcards</strong>. Such a generic rule might look as
follows:</p>
<pre class="snakemake"><code># Count number of generated trajectories for any ensemble
rule count_trajectories:
    input: "raw_data/{subdir}/out_pg"
    output: "intermediary_data/{subdir}/pg.count"
    shell:
        "grep -c generated {input} &gt; {output}"</code></pre>
<div id="comments-in-snakefiles" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="comments-in-snakefiles" class="callout-inner">
<h3 class="callout-title">Comments in Snakefiles</h3>
<div class="callout-content">
<p>In the above code, the line beginning <code>#</code> is a comment
line. Hopefully you are already in the habit of adding comments to your
own software. Good comments make any code more readable, and this is
just as true with Snakefiles.</p>
</div>
</div>
</div>
<p><code>{subdir}</code> here is an example of a
<strong>wildcard</strong> Wildcards are used in the <code>input</code>
and <code>output</code> lines of the rule to represent parts of
filenames. Much like the <code>*</code> pattern in the shell, the
wildcard can stand in for any text in order to make up the desired
filename. As with naming your rules, you may choose any name you like
for your wildcards; so here we used <code>subdir</code>, since it is
describing a subdirectory. If <code>subdir</code> is set to
<code>beta4.0</code> then the new generic rule will have the same inputs
and outputs as the original rule. Using the same wildcards in the input
and output is what tells Snakemake how to match input files to output
files.</p>
<p>If two rules use a wildcard with the same name then Snakemake will
treat them as different entities—rules in Snakemake are self-contained
in this way.</p>
<p>Meanwhile, <code>{input}</code> and <code>{output}</code> are
<strong>placeholders</strong> Placeholders are used in the
<code>shell</code> section of a rule. Snakemake will replace them with
appropriate values before running the command: <code>{input}</code> with
the full name of the input file, and <code>{output}</code> with the full
name of the output file.</p>
<p>If we had wanted to include the value of the <code>subdir</code>
wildcard directly in the <code>shell</code> command, we could have used
the placeholder <code>{wildcards.subdir}</code>, but in most cases, as
here, we just need the <code>{input}</code> and <code>{output}</code>
placeholders.</p>
<p>Let’s test this general rule now:</p>
<pre class="shellsession"><code>snakemake --jobs 1 --forceall --printshellcmds --use-conda intermediary_data/beta4.0/pg.count</code></pre>
<p>As previously, if you see errors at this point, there is likely a
problem with your Snakefile; check that all the rules match the ones
that have appeared here, and that there aren’t multiple rules with the
same name.</p>
<div id="general-plaquette-computation" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="general-plaquette-computation" class="callout-inner">
<h3 class="callout-title">General plaquette computation</h3>
<div class="callout-content">
<p>Modify your Snakefile so that it can compute the average plaquette
for any ensemble, not just the ones we wrote specific rules for in the
previous episode.</p>
<p>Test this with some of the values of <span class="math inline">\(\beta\)</span> present in the raw data.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>The replacement rule should look like:</p>
<pre class="snakemake"><code># Compute average plaquette for any ensemble from its generation log
rule avg_plaquette:
    input: "raw_data/{subdir}/out_pg"
    output: "intermediary_data/{subdir}/pg.plaquette.json.gz"
    conda: "envs/analysis.yml"
    shell:
        "python -m su2pg_analysis.plaquette {input} --output_file {output}"</code></pre>
<p>To test this, for example:</p>
<pre class="shellsession"><code>snakemake --jobs 1 --forceall --printshellcmds --use-conda intermediary_data/beta3.0/pg.plaquette.json.gz</code></pre>
</div>
</div>
</div>
</div>
<div id="choosing-the-right-wildcards" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="choosing-the-right-wildcards" class="callout-inner">
<h3 class="callout-title">Choosing the right wildcards</h3>
<div class="callout-content">
<p>Our rule puts the sequence counts into output files named like
<code>pg.count</code>. How would you have to change the
`count_trajectories`` rule definition if you wanted:</p>
<ol style="list-style-type: decimal">
<li><p>the output file for <code>raw_data/beta3.0/out_hmc</code> to be
<code>intermediary_data/beta3.0/hmc.count</code>?</p></li>
<li><p>the output file for
<code>raw_data/beta3.0/mass_fun-0.63/out_hmc</code> to be
<code>intermediary_data/beta3.0/mass_fun-0.63/hmc.count</code>?</p></li>
<li><p>the output file for
<code>raw_data/beta3.0/mass_fun-0.63/out_hmc</code> to be
<code>intermediary_data/hmc_b3.0_m-0.63.count</code> (for
<code>raw_data/beta3.5/mass_fun-0.68/out_pg</code> to be
<code>intermediary_data/hmc_b3.5_m-0.68.count</code>, etc.)?</p></li>
<li><p>the output file for
<code>raw_data/beta3.0/mass_fun-0.63/out_hmc</code> to be
<code>intermediary_data/hmc_m-0.63.count</code> (for
<code>raw_data/beta3.5/mass_fun-0.68/out_pg</code> to be
<code>intermediary_data/hmc_m-0.68.count</code>, etc.)?</p></li>
</ol>
<p>(Assume that both pure-gauge and HMC logs tag generated trajectories
the same way. Note that input files for the latter data are not included
in the sample data, so these will not work as-is.)</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p>In both cases, there is no need to change the <code>shell</code> part
of the rule at all.</p>
<ol style="list-style-type: decimal"><li>
</li></ol>
<pre class="snakemake"><code><span><span class="va">input</span><span class="op">:</span> <span class="st">"raw_data/{subdir}/out_hmc"</span></span>
<span><span class="va">output</span><span class="op">:</span> <span class="st">"intermediary_data/{subdir}/hmc.count"</span></span></code></pre>
<p>This can be done by changing only the static parts of the
<code>input:</code> and <code>output:</code> lines.</p>
<ol start="2" style="list-style-type: decimal"><li>
</li></ol>
<p>This in fact requires no change from the previous answer. The
wildcard <code>{subdir}</code> can include <code>/</code>, so can
represent multiple levels of subdirectory.</p>
<ol start="3" style="list-style-type: decimal"><li>
</li></ol>
<pre class="snakemake"><code><span><span class="va">input</span><span class="op">:</span> <span class="st">"raw_data/beta{beta}/mass_fun{mass}/out_hmc"</span></span>
<span><span class="va">output</span><span class="op">:</span> <span class="st">"intermediary_data/hmc_b{beta}_m{mass}.count"</span></span></code></pre>
<p>In this case, it was necessary to change the wildcards, because the
subdirectory name needs to be split to obtain the values of <span class="math inline">\(\beta\)</span> and <span class="math inline">\(m_{\mathrm{fun}}\)</span>. The names chosen here
are <code>{beta}</code> and <code>{mass}</code>, but you could choose
any names, as long as they match between the <code>input</code> and
<code>output</code> parts.</p>
<ol start="4" style="list-style-type: decimal"><li>
</li></ol>
<p>This one <strong>isn’t possible</strong>, because Snakemake cannot
determine which input file you want to count by matching wildcards on
the file name <code>intermediary_data/hmc_m-0.63.count</code>. You could
try a rule like this:</p>
<pre class="snakemake"><code><span><span class="va">input</span><span class="op">:</span> <span class="st">"raw_data/beta3.0/mass_fun{mass}/out_hmc"</span></span>
<span><span class="va">output</span><span class="op">:</span> <span class="st">"intermediary_data/hmc_m{mass}.count"</span></span></code></pre>
<p>…but it only works because <span class="math inline">\(\beta\)</span>
is hard-coded into the <code>input</code> line, and the rule will only
work on this specific sample, not other cases where other values of
<span class="math inline">\(\beta\)</span> may be wanted. In general,
input and output filenames need to be carefully chosen so that Snakemake
can match everything up and determine the right input from the output
filename.</p>
</div>
</div>
</div>
</div>
<div id="filenames-arent-data" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="filenames-arent-data" class="callout-inner">
<h3 class="callout-title">Filenames aren’t data</h3>
<div class="callout-content">
<p>Notice that in some examples we can pull out the value of <span class="math inline">\(\beta\)</span> from the name of the directory in
which the file is located. However, ideally, we should avoid relying on
this being correct. The name and location are useful for us to find the
correct file, but we should try to ensure that the file contents also
contain these data, and that we make use of those data in preference to
the filename.</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="snakemake-order-of-operations">Snakemake order of operations<a class="anchor" aria-label="anchor" href="#snakemake-order-of-operations"></a>
</h2>
<hr class="half-width">
<p>We’re only just getting started with some simple rules, but it’s
worth thinking about exactly what Snakemake is doing when you run it.
There are three distinct phases:</p>
<ol style="list-style-type: decimal">
<li>Prepares to run:
<ol style="list-style-type: decimal">
<li>Reads in all the rule definitions from the Snakefile</li>
</ol>
</li>
<li>Plans what to do:
<ol style="list-style-type: decimal">
<li>Sees what file(s) you are asking it to make</li>
<li>Looks for a matching rule by looking at the <code>output</code>s of
all the rules it knows</li>
<li>Fills in the wildcards to work out the <code>input</code> for this
rule</li>
<li>Checks that this input file is actually available</li>
</ol>
</li>
<li>Runs the steps:
<ol style="list-style-type: decimal">
<li>Creates the directory for the output file, if needed</li>
<li>Removes the old output file if it is already there</li>
<li>Only then, runs the shell command with the placeholders
replaced</li>
<li>Checks that the command ran without errors <em>and</em> made the new
output file as expected</li>
</ol>
</li>
</ol>
<p>For example, if we now ask Snakemake to generate a file named
<code>intermediary_data/wibble_1/pg.count</code>:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>$ snakemake --jobs 1 --forceall --printshellcmds intermediary_data/wibble_1/pg.count
Building DAG of jobs...
MissingInputException in line 1 of /home/zenmaster/data/su2pg/workflow/Snakefile:
Missing input files for rule count_trajectories:
    output: intermediary_data/wibble_1/pg.count
    wildcards: subdir=wibble_1
    affected files:
        raw_data/wibble_1/out_pg</code></pre>
</div>
<p>Snakemake sees that a file with a name like this could be produced by
the <code>count_trajectories</code> rule. However, when it performs the
wildcard substitution it sees that the input file would need to be named
<code>raw_data/wibble_1/out_pg</code>, and there is no such file
available. Therefore Snakemake stops and gives an error before any shell
commands are run.</p>
<div id="dry-run---dry-run-mode" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="dry-run---dry-run-mode" class="callout-inner">
<h3 class="callout-title">Dry-run (<code>--dry-run</code>) mode</h3>
<div class="callout-content">
<p>It’s often useful to run just the first two phases, so that Snakemake
will plan out the jobs to run, and print them to the screen, but never
actually run them. This is done with the <code>--dry-run</code> flag,
eg:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="ex">$</span> snakemake <span class="at">--dry-run</span> <span class="at">--forceall</span> <span class="at">--printshellcmds</span> temp33_1_1.fq.count</span></code></pre>
</div>
<p>We’ll make use of this later in the lesson.</p>
</div>
</div>
</div>
<p>The amount of checking may seem pedantic right now, but as the
workflow gains more steps this will become very useful to us indeed.</p>
<!-- maybe add an extra challenge here? -->
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Snakemake rules are made generic with placeholders and
wildcards</li>
<li>Snakemake chooses the appropriate rule by replacing wildcards such
the the output matches the target</li>
<li>Placeholders in the shell part of the rule are replaced with values
based on the chosen wildcards</li>
<li>Snakemake checks for various error conditions and will stop if it
sees a problem</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-chaining"><p>Content from <a href="chaining.html">Chaining rules</a></p>
<hr>
<p>Last updated on 2025-05-20 |

        <a href="https://github.com/edbennett/snakemake-novice-lattice/edit/main/episodes/chaining.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I combine rules into a workflow?</li>
<li>How can I make a rule with multiple input files?</li>
<li>How should I refer to multiple files with similar names?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Use Snakemake to filter and then count the sequences in a FASTQ
file</li>
<li>Understand how rules are linked by filename patterns</li>
<li>Be able to use multiple input files in one rule</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="a-pipeline-of-multiple-rules">A pipeline of multiple rules<a class="anchor" aria-label="anchor" href="#a-pipeline-of-multiple-rules"></a>
</h2>
<hr class="half-width">
<p>We have so far been able to count the number of generated
trajectories, and compute the average plaquette, given an output log
from the configuration generation. However, an individual average
plaquette is not interesting in isolation; what is more interesting is
how it varies between different values of the input parameters. To do
this, we will need to take the output of the <code>avg_plaquette</code>
rule that we defined earlier, and use it as input for another rule.</p>
<p>Let’s define that rule now:</p>
<pre class="snakemake"><code>rule plot_avg_plaquette:
    input:
        "intermediary_data/beta3.0/pg.plaquette.json.gz",
        "intermediary_data/beta3.5/pg.plaquette.json.gz",
        "intermediary_data/beta4.0/pg.plaquette.json.gz",
    output:
        "assets/plots/plaquette_scan.pdf"
    conda: "envs/analysis.yml"
    shell:
        "python src/plot_plaquette.py {input} --output_filename {output}"</code></pre>
<div id="callout1" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>You can see that here we’re putting “files that want to be included
in a paper” in an <code>assets</code> directory, similarly to the
<code>raw_data</code> and <code>intermediary_data</code> directories we
discussed in a previous episode. It can be useful to further distinguish
plots, tables, and other definitions, by using subdirectories in this
directory.</p>
</div>
</div>
</div>
<p>Rather than one input, as we have seen in rules so far, this rule
requires three. When Snakemake substitutes these into the
<code>{input}</code> placeholder, it will automatically add a space
between them. Let’s test this now:</p>
<pre class="shellsession"><code>snakemake --jobs 1 --forceall --printshellcmds --use-conda assets/plots/plaquette_scan.pdf</code></pre>
<p>Look at the logging messages that Snakemake prints in the terminal.
What has happened here?</p>
<ol style="list-style-type: decimal">
<li>Snakemake looks for a rule to make
<code>assets/plots/plaquette_scan.pdf</code>
</li>
<li>It determines that the <code>plot_avg_plaquette</code> rule can do
this, if it has
<code>intermediary_data/beta3.0/pg.plaquette.json.gz</code>,
<code>intermediary_data/beta3.5/pg.plaquette.json.gz</code>, and
<code>intermediary_data/beta4.0/pg.plaquette.json.gz</code>.</li>
<li>Snakemake looks for a rule to make
<code>intermediary_data/beta3.0/pg.plaquette.json.gz</code>
</li>
<li>It determines that <code>avg_plaquette</code> can make this if
<code>subdir=beta3.0</code>
</li>
<li>It sees that the input needed is therefore
<code>raw_data/beta3.0/out_pg</code>
</li>
<li>Now Snakemake has reached an available input file, it runs the
<code>avg_plaquette</code> rule.</li>
<li>It then looks through the other two <span class="math inline">\(\beta\)</span> values in turn, repeating the
process until it has all of the needed inputs.</li>
<li>Finally, it runs the <code>plot_avg_plaquette</code> rule.</li>
</ol>
<p><strong>Here’s a visual representation of this process:</strong></p>
<p>![][fig-chaining]</p>
<p>This, in a nutshell, is how we build workflows in Snakemake.</p>
<ol style="list-style-type: decimal">
<li>Define rules for all the processing steps</li>
<li>Choose <code>input</code> and <code>output</code> naming patterns
that allow Snakemake to link the rules</li>
<li>Tell Snakemake to generate the final output files</li>
</ol>
<p>If you are used to writing regular scripts this takes a little
getting used to. Rather than listing steps in order of execution, you
are always <strong>working backwards</strong> from the final desired
result. The order of operations is determined by applying the pattern
matching rules to the filenames, not by the order of the rules in the
Snakefile.</p>
<div id="choosing-file-name-patterns" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="choosing-file-name-patterns" class="callout-inner">
<h3 class="callout-title">Choosing file name patterns</h3>
<div class="callout-content">
<p>Chaining rules in Snakemake is a matter of choosing filename patterns
that connect the rules. There’s something of an art to it, and most
times there are several options that will work, but in all cases the
file names you choose will need to be consistent and unabiguous.</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="making-file-lists-easier">Making file lists easier<a class="anchor" aria-label="anchor" href="#making-file-lists-easier"></a>
</h2>
<hr class="half-width">
<p>In the rule above, we plotted the average plaquette for three values
of <span class="math inline">\(\beta\)</span> by listing the files
expected to contain their values. In fact, we have data for a larger
number of <span class="math inline">\(\beta\)</span> values, but typing
out each file by hand would be quite cumbersome. We can make use of the
<code>expand()</code> function to do this more neatly:</p>
<pre class="snakemake"><code>    input:
        expand(
            "intermediary_data/beta{beta}/pg.plaquette.json.gz",
            beta=[2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0],
        )</code></pre>
<p>The first argument to <code>expand()</code> here is a template for
the filename, and subsequent keyword arguments are lists of variables to
fill into the placeholders. The output is the cartesian product of all
the parameter lists.</p>
<p>We can check that this works correctly:</p>
<pre class="shellsession"><code>snakemake --jobs 1 --forceall --printshellcmds --use-conda assets/plots/plaquette_scan.pdf</code></pre>
<div id="tabulating-trajectory-counts" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="tabulating-trajectory-counts" class="callout-inner">
<h3 class="callout-title">Tabulating trajectory counts</h3>
<div class="callout-content">
<p>The script <code>src/tabulate_counts.py</code> will take a list of
files containing plaquette data, and output a LaTeX table of trajectory
counts. Write a rule to generate this table for all values of <span class="math inline">\(\beta\)</span>, and output it to
<code>assets/tables/counts.tex</code>.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Solution 1
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>The replacement rule should look like:</p>
<pre class="snakemake"><code># Output a LaTeX table of trajectory counts
rule tabulate_counts:
    input:
        expand(
            "intermediary_data/beta{beta}/pg.count",
            beta=[2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0],
        )
    output: "assets/tables/counts.tex"
    conda: "envs/analysis.yml"
    shell:
        "python src/tabulate_counts.py {input} &gt; {output}"</code></pre>
<p>To test this, for example:</p>
<pre class="shellsession"><code>snakemake --jobs 1 --forceall --printshellcmds --use-conda assets/tables/counts.tex</code></pre>
</div>
</div>
</div>
</div>
<div id="tabulating-trajectory-counts" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="tabulating-trajectory-counts" class="callout-inner">
<h3 class="callout-title">Tabulating trajectory counts<em>
(continued)</em>
</h3>
<div class="callout-content">
<p>This setup currently requires reading the value of <span class="math inline">\(\beta\)</span> from the filename. Why is this not
ideal? How would the workflow need to be changed to avoid this?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Solution 2
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>It’s easy for files to be misnamed when creating or copying them.
Putting the wrong data into the file is harder, especially when it’s a
raw data file generated by the same program as the rest of the data. (If
the wrong value were given as input, this could happen, but the
corresponding output data would also be generated at that incorrect
value. Provided the values are treated consistently, the downstream
analysis could in fact still be valid, just not exactly as
intended.)</p>
<p>Currently, <code>grep -c</code> is used to count the number of
trajectories. This would need to be replaced or supplemented with a tool
that read out the value of <span class="math inline">\(\beta\)</span>
from the input log, and outputs it along with the trajectory count. The
<code>src/tabulate_counts.py</code> script could then be updated to use
this number, rather than the filename.</p>
<p>In fact, the <code>plaquette</code> module does just this; in
addition to the average plaquette, it also records the number of
trajectories generated as part of the metadata and provenance
information it tracks.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Snakemake links up rules by iteratively looking for rules that make
missing inputs</li>
<li>Careful choice of filenames allows this to work</li>
<li>Rules may have multiple named input files (and output files)</li>
<li>Use <code>expand()</code> to generate lists of filenames from a
template</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-parameters"><p>Content from <a href="parameters.html">Metadata and parameters</a></p>
<hr>
<p>Last updated on 2025-05-20 |

        <a href="https://github.com/edbennett/snakemake-novice-lattice/edit/main/episodes/parameters.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<section><h2 class="section-heading" id="global-parameters">Global parameters<a class="anchor" aria-label="anchor" href="#global-parameters"></a>
</h2>
<hr class="half-width">
<p>Thus far, each of our rules has taken one or more input files, and
given output files solely based on that. However, in some cases we may
want to control options without having them within an input file.</p>
<p>For example, in the previous episode, we wrote a rule to plot a graph
using the script <code>src/plot_plaquette.py</code>. The style of output
we got was good for a paper, but if we were producing a poster, or
putting the plot onto a slide with a dark background, we may wish to use
a different output style. The <code>plot_plaquette.py</code> script
accepts a <code>--styles</code> argument, to tell it what style file to
use to plot. One way to make use of this would be to add
<code>--styles styles/paper.mplstyle</code> directly to the
<code>shell:</code> block. However, if we had many such rules, and
wanted to switch from generating output for a paper to generating it for
a poster, then we would need to change the value in many places.
Instead, we can define a variable at the top of the Snakefile</p>
<pre class="snakefile"><code><span><span class="va">plot_styles</span> <span class="op">=</span> <span class="st">"styles/jhep.mplstyle"</span></span></code></pre>
<p>Then, when we use a script to generate a plot, we can update the
<code>shell:</code> block of the corresponding rule similarly to</p>
<pre><code><span><span class="st">"python src/plot_plaquette.py {input} --output_filename {output} --plot_styles {plot_styles}"</span></span></code></pre>
<p>Snakemake will substitute the value of the global
<code>plot_styles</code> variable in place of the
<code>{plot_styles}</code> placeholder.</p>
<p>We can test this by changing <code>paper</code> to
<code>poster</code>, and running</p>
<pre class="shellsession"><code>snakemake --jobs 1 --forceall --printshellcmds --use-conda assets/plots/plaquette_scan.pdf</code></pre>
<p>We can see that the generated file now uses a different set of
fonts.</p>
<div id="wilson-flow" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="wilson-flow" class="callout-inner">
<h3 class="callout-title">Wilson flow</h3>
<div class="callout-content">
<p>The tool <code>su2pg_analysis.w0</code> computes the scale <span class="math inline">\(w_0\)</span> given a log of the energy density
during evolution of the Wilson flow for an ensemble. To do this, the
reference scale <span class="math inline">\(\mathcal{W}_0\)</span> needs
to be passed to the <code>--W0</code> parameter. Use this, and the logs
stored in the files <code>out_wflow</code> for each ensemble’s raw data
directory, to output the <span class="math inline">\(w_0\)</span> scale
in a file <code>wflow.w0.json</code> for each ensemble, taking the
reference value <span class="math inline">\(\mathcal{W_0} =
0.2\)</span>.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<pre class="snakemake"><code>W0_reference = 0.2

rule w0:
    input: "raw_data/{subdir}/out_wflow"
    output: "intermediary_data/{subdir}/wflow.w0.json.gz"
    conda: "envs/analysis.yml"
    shell:
        "python -m su2pg_analysis.w0 {input} --W0 {W0_reference} --output_file {output}"</code></pre>
</div>
</div>
</div>
</div>
<div id="generating-different-filetypes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="generating-different-filetypes" class="callout-inner">
<h3 class="callout-title">Generating different filetypes</h3>
<div class="callout-content">
<p>In addition to different plot styles, we may also wish to generate
different filetypes. PDF is useful for including in LaTeX, but SVG may
be a better format to use with some tools.</p>
<p>If we add a global definition:</p>
<pre class="snakemake"><code><span><span class="va">plot_filetype</span> <span class="op">=</span> <span class="st">"pdf"</span></span></code></pre>
<p>and update the <code>output:</code> block of the rule as:</p>
<pre class="snakemake"><code><span>    <span class="va">output</span><span class="op">:</span></span>
<span>        <span class="st">"assets/plots/plaquette_scan.{plot_filetype}"</span></span></code></pre>
<p>does this have the same effect as the example with
<code>--styles</code> above?</p>
<p>(Hint: what happens when you try to make the targets
<code>assets/plots/plaquette_scan.svg</code> and
<code>assets/plots/plaquette_scan.txt</code> by specifying them at the
command line, without changing the value of
<code>plot_filetype</code>?)</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>This can achieve a similar result, but in a slightly different way.
In the <code>--styles</code> example, the <code>{plot_styles}</code>
string is in the <code>shell:</code> block, and so directly looks up the
<code>plot_styles</code> variable. (Recall that to look up a wildcard,
we needed to explicitly use <code>wildcards.</code>.)</p>
<p>However, in this case the <code>{plot_filetype}</code> string is in
the <code>output:</code> block, so defines a wildcard. This may take any
value, so if we instruct <code>snakemake</code> to produce
<code>plaquette_scan.txt</code>, it will diligently pass that filename
to <code>plot_plaquette.py</code>.</p>
<p>The <code>plot_filetype = "pdf"</code> is in fact ignored. It could
however be used to set a default set of targets to generate, which we
will talk about in a later episode.</p>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="metadata-from-a-file">Metadata from a file<a class="anchor" aria-label="anchor" href="#metadata-from-a-file"></a>
</h2>
<hr class="half-width">
<p>We would frequently like our rules to depend on data that are
specific to the specific ensembles being analysed. For example, consider
the rule:</p>
<pre class="snakemake"><code>rule ps_mass:
    input: "raw_data/{subdir}/out_corr"
    output: "intermediary_data/{subdir}/corr.ps_mass.gz"
    conda: "envs/analysis.yml"
    shell:
        "python -m su2pg_analysis.meson_mass {input} --output_file {output} --plateau_start 18 --plateau_end 23"</code></pre>
<p>This rule hardcodes the positions of the start and end of the plateau
region. In most studies, each ensemble and observable may have a
different plateau position, so there is no good value to hardcode this
to. Instead, we’d like a way of picking the right value from some list
of parameters that we specify.</p>
<p>We could do this within the Snakefile, but where possible it is good
to avoid mixing data with code. We shouldn’t need to modify our code
every time we add or modify the data it is analysing. Instead, we’d like
to have a dedicated file containing these parameters, and to be able to
have Snakemake read it and pick out the correct values.</p>
<p>To do this, we can exploit the fact that Snakemake is an extension of
Python. In particular, Snakemake makes use of the <a href="https://pandas.pydata.org" class="external-link">Pandas</a> library for tabular data,
which we can use to read in a CSV files. Let’s add the following to the
top of the file:</p>
<pre class="snakemake"><code>import pandas

metadata = pandas.read_csv("metadata/ensemble_metadata.csv")</code></pre>
<p>The file being read here is a CSV (Comma Separated Values) file. We
can create, view, and modify this with the spreadsheet tool of our
choice. Let’s take a look at the file now.</p>
<figure><img src="./images/metadata_excel.png" alt="Screenshot of a spreadsheet application showing the file metadata/ensemble_metadata.csv." class="figure mx-auto d-block"><div class="figcaption">Screenshot of a spreadsheet application showing
the file <code>metadata/ensemble_metadata.csv</code>.</div>
</figure><p>You can see that we have columns defining metadata to identify each
ensemble, and columns for parameters relating to the analysis of each
ensemble.</p>
<p>Now, how do we tell Snakemake to pull out the correct value from
this?</p>
<pre class="snakemake"><code>rule ps_mass:
    input: "raw_data/beta{beta}/out_corr"
    output: "intermediary_data/beta{beta}/corr.ps_mass.json.gz"
    params:
        plateau_start: lookup(within=metadata, query="beta = {beta}", cols="ps_plateau_start"),
        plateau_end: lookup(within=metadata, query="beta = {beta}", cols="ps_plateau_end"),
    conda: "envs/analysis.yml"
    shell:
        "python -m su2pg_analysis.meson_mass {input} --output_file {output} --plateau_start {params.plateau_start} --plateau_end {params.plateau_end}"</code></pre>
<p>We’ve done a couple of things here. Firstly, we’ve made explicit the
reference to <span class="math inline">\(\beta\)</span> in the file
paths, so that we can use <code>beta</code> as a wildcard, similarly to
in the challenge in the previous episode. Secondly, we’ve introduced a
<code>params:</code> block. This is how we tell Snakemake about
quantities that may vary from run to run, but that are not filenames.
Thirdly, we’ve used the <code>lookup()</code> function to search the
<code>metadata</code> dataframe for the ensemble that we are
considering. Finally, we’ve used <code>{params.plateau_start}</code> and
<code>{params.plateau_end}</code> placeholders to use these parameters
in the shell command that gets run.</p>
<p>Let’s test this now:</p>
<pre class="shellsession"><code>snakemake --jobs 1 --forceall --printshellcmds --use-conda intermediary_data/beta4.0/corr.ps_mass.json
cat intermediary_data/beta4.0/corr.ps_mass.json</code></pre>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">TODO</span></span></code></pre>
</div>
<p>TODO CHALLENGE</p>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-multiple"><p>Content from <a href="multiple.html">Multiple inputs and outputs</a></p>
<hr>
<p>Last updated on 2025-05-20 |

        <a href="https://github.com/edbennett/snakemake-novice-lattice/edit/main/episodes/multiple.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<section><h2 class="section-heading" id="multiple-outputs">Multiple outputs<a class="anchor" aria-label="anchor" href="#multiple-outputs"></a>
</h2>
<hr class="half-width">
<p>Quite frequently, we will want a rule to be able to generate more
than one file. It’s important we let Snakemake know about this, both so
that it can instruct our tools on where to place these files, and so it
can verify that they are correctly created by the rule. For example,
when fitting a correlation function with a plateau region that we
specify, it’s important to look at an effective mass plot to verify that
the plateau actually matches what we assert. The rule we just wrote
doesn’t do this—it only spits out a numerical answer. Let’s update this
rule so that it can also generate the effective mass plot.</p>
<pre class="snakemake"><code>rule ps_mass:
    input: "raw_data/beta{beta}/out_corr"
    output:
        data="intermediary_data/beta{beta}/corr.ps_mass.json.gz",
        plot="intermediary_data/beta{beta}/corr.ps_eff_mass.{plot_filetype}",
    params:
        plateau_start: lookup(within=metadata, query="beta = {beta}", cols="ps_plateau_start"),
        plateau_end: lookup(within=metadata, query="beta = {beta}", cols="ps_plateau_end"),
    conda: "envs/analysis.yml"
    shell:
        "python -m su2pg_analysis.meson_mass {input} --output_file {output.data} --plateau_start {params.plateau_start} --plateau_end {params.plateau_end} --plot_file {output.plot} --plot_styles {plot_styles}"</code></pre>
<p>Rather than having a single string after <code>output:</code>, we now
have a block with two lines. Each line has the format
<code>name=value</code>, and is followed by a comma. To make use of
these variables in our rule, we follow <code>output</code> by a
<code>.</code>, and then the name of the variable we want to use,
similarly to what we do for <code>wildcards</code> and
<code>params</code>.</p>
<div id="non-specificity" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="non-specificity" class="callout-inner">
<h3 class="callout-title">Non-specificity</h3>
<div class="callout-content">
<p>What happens if we define multiple named <code>output:</code>
variables like this, but refer to the <code>{output}</code> placeholder
in the <code>shell:</code> block without specifying a variable name?</p>
<p>(One way to find this out is to try <code>echo {output}</code> as the
entire <code>shell:</code> content; this will generate a missing output
error, but will first let you see what the output is.)</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>Snakemake will provide all of the defined output variables, as a
space-separated list. This is similar to what happens when an output
variable is a list, as we saw earlier when looking at the
<code>expand()</code> function.</p>
</div>
</div>
</div>
</div>
<div id="flow-plots" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="flow-plots" class="callout-inner">
<h3 class="callout-title">Flow plots</h3>
<div class="callout-content">
<p>Update the Wilson flow <span class="math inline">\(w_0\)</span>
computation that we looked at in a previous challenge to also output the
flow of <span class="math inline">\(\mathcal{W}(t)\)</span>, so that the
shape of the flow may be checked.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<pre class="snakemake"><code>rule w0:
    input: "raw_data/{subdir}/out_wflow"
    output:
        data="intermediary_data/{subdir}/wflow.w0.json.gz",
        plot="intermediary_data/{subdir}/wflow.W_flow.{plot_filetype}",
    conda: "envs/analysis.yml"
    shell:
        "python -m su2pg_analysis.w0 {input} --W0 {W0_reference} --output_file {output} --plot_file {output.plot} --plot_styles {plot_styles}"</code></pre>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="multiple-inputs">Multiple inputs<a class="anchor" aria-label="anchor" href="#multiple-inputs"></a>
</h2>
<hr class="half-width">
<p>Similarly to outputs, there are many situations where we want to work
with more than one class of input file—for example, to combine differing
observables into one. For example, the <code>meson_mass</code> rule we
wrote previously also outputs the amplitude of the exponential. When
combined with the average plaquette via one-loop matching, this can be
used to give an estimate of the decay constant. The syntax for this is
the same as we saw above for <code>output:</code>.</p>
<pre class="snakemake"><code>rule one_loop_matching:
    input:
        plaquette="intermediary_data/{subdir}/pg.plaquette.json.gz",
        meson="intermediary_data/{subdir}/corr.{channel}_mass.json.gz",
    output:
        data="intermediary_data/{subdir}/pg.corr.{channel}_decay_const.json.gz",
    conda: "envs/analysis.yml"
    shell:
        "python -m su2pg_analysis.one_loop_matching --plaquette {input.plaquette} --meson {input.meson} --output_file {output.data}"</code></pre>
<div id="naming-things" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="naming-things" class="callout-inner">
<h3 class="callout-title">Naming things</h3>
<div class="callout-content">
<p>Even when there is only one <code>output:</code> file, we are still
allowed to name it. This makes life easier if we need to add more
outputs later, and can make it a little clearer what our intent is when
we come to read the workflow later.</p>
</div>
</div>
</div>
<div id="spectrum-plot" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="spectrum-plot" class="callout-inner">
<h3 class="callout-title">Spectrum plot</h3>
<div class="callout-content">
<p>Write a rule that plots the pseudoscalar channel’s decay constant
against its mass, for each ensemble studied. The tool
<code>src/plot_spectrum.py</code> will help with this.</p>
<p>Try making the filename of the tool a parameter too, so that if the
script is changed, Snakemake will correctly re-run the workflow.</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<pre class="snakemake"><code>rule spectrum:
    input:
        script="src/plot_spectrum.py",
        ps_mass="intermediary_data/{subdir}/corr.{channel}_mass.json.gz",
        ps_decay_const="intermediary_data/{subdir}/pg.corr.{channel}_decay_const.json.gz",
    output:
        plot="assets/plots/spectrum.{plot_filetype}"
    conda: "envs/analysis.yml"
    shell:
        "python {input.script} {input.ps_mass} {input.ps_decay_const} --output_file {output.plot} --plot_styles {plot_styles}"</code></pre>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="log-files">Log files<a class="anchor" aria-label="anchor" href="#log-files"></a>
</h2>
<hr class="half-width">
<p>When a process run by Snakemake exits with an error code, Snakemake
removes all the expected output files. Usually this is what we want: we
don’t want to have potentially corrupt output, that might be used as
input for subsequent rules. However, there are some classes of output
file that are useful in helping to identify what caused the error in the
first place: log files.</p>
<p>We can tell Snakemake that specified files are log files, rather than
regular output files, by placing them in a <code>log:</code> block
rather than an <code>output:</code> one. Snakemake will not delete a
file marked as a log if an error is raised by the process generating
it.</p>
<p>For example, for the <code>ps_mass</code> rule above, we might
use:</p>
<pre class="snakemake"><code>rule ps_mass:
    input:
        data="raw_data/beta{beta}/out_corr",
    output:
        data="intermediary_data/beta{beta}/corr.ps_mass.json.gz",
        plot="intermediary_data/beta{beta}/corr.ps_eff_mass.{plot_filetype}",
    log:
        messages="intermediary_data/beta{beta}/corr.ps_mass.log",
    params:
        plateau_start: lookup(within=metadata, query="beta = {beta}", cols="ps_plateau_start"),
        plateau_end: lookup(within=metadata, query="beta = {beta}", cols="ps_plateau_end"),
    conda: "envs/analysis.yml"
    shell:
        "python -m su2pg_analysis.meson_mass {input.data} --output_file {output.data} --plateau_start {params.plateau_start} --plateau_end {params.plateau_end} --plot_file {output.plot} --plot_styles {plot_styles} |&amp; tee {log.messages}"</code></pre>
<div id="tee" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="tee" class="callout-inner">
<h3 class="callout-title"><code>|&amp; tee</code></h3>
<div class="callout-content">
<p>You may recall that <code>|</code> is the pipe operator in the Unix
shell, taking standard output from one program and passing it to
standard input of the next. (If this is unfamiliar, you may wish to look
through the Software Carpentry introduction to [the Unix
shell][shell-novice] when you have a moment.)</p>
<p>Adding the <code>&amp;</code> symbol means that both the standard
output and standard error streams are piped, rather than only standard
output. This is useful for a log file, since we will typically want to
see errors there.</p>
<p>The <code>tee</code> command “splits a pipe”; that is, it takes
standard input and outputs it both to standard output and to the
specified filename. This way, we get the log on disk, but also output to
screen as well, so we can monitor issues as the workflow runs.</p>
</div>
</div>
</div>
<div id="logged-plots" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="logged-plots" class="callout-inner">
<h3 class="callout-title">Logged plots</h3>
<div class="callout-content">
<p>Adjust the solution for plotting the spectrum above so that any
warnings or errors generated by the plotting script are logged to a
file.</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4"> Show me the solution </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" data-bs-parent="#accordionSolution4" aria-labelledby="headingSolution4">
<div class="accordion-body">
<pre class="snakemake"><code>rule spectrum:
    input:
        script="src/plot_spectrum.py",
        ps_mass="intermediary_data/{subdir}/corr.{channel}_mass.json.gz",
        ps_decay_const="intermediary_data/{subdir}/pg.corr.{channel}_decay_const.json.gz",
    output:
        plot="assets/plots/spectrum.{plot_filetype}"
    log:
        messages="intermediary_data/{subdir}/pg.corr.{channel}_mass.log"
    conda: "envs/analysis.yml"
    shell:
        "python {input.script} {input.ps_mass} {input.ps_decay_const} --output_file {output.plot} --plot_styles {plot_styles} |&amp; tee {log.messages}"</code></pre>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="dealing-with-errors">Dealing with errors<a class="anchor" aria-label="anchor" href="#dealing-with-errors"></a>
</h2>
<hr class="half-width">
<p>We’ll end the chapter by looking at a common problem that can arise
if you mistype a filename in a rule. It may seem silly to break the
workflow when we just got it working, but it will be instructive, so
let’s modify the Snakefile and deliberately specify an incorrect output
filename in the <code>ps_mass</code> rule.</p>
<pre class="snakemake"><code><span><span class="va">...</span></span>
<span><span class="va">shell</span><span class="op">:</span></span>
<span>        <span class="st">"python -m su2pg_analysis.meson_mass {input.data} --output_file {output.data}.json_ --plateau_start {params.plateau_start} --plateau_end {params.plateau_end} --plot_file {output.plot} --plot_styles {plot_styles} |&amp; tee {log.messages}"</span></span></code></pre>
<p>To keep things tidy, this time we’ll manually remove the intermediary
data directory.</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">$</span> rm <span class="at">-rvf</span> intermediary_data</span></code></pre>
</div>
<p>And re-run.</p>
<pre class="shellsession"><code>$ snakemake --jobs 1 --forceall --printshellcmds --use-conda intermediary_data/beta4.0/corr.ps_mass.json

...
TODO</code></pre>
<p>There’s a lot to take in here. Some of the messages are very
informative. Some less so.</p>
<ol style="list-style-type: decimal">
<li>Snakemake did actually run the tool, as evidenced by the output from
the program that we see on the screen.</li>
<li>Python is reporting that there is a file missing.</li>
<li>Snakemake complains one expected output file is missing:
<code>intermediary_data/beta4.0/corr.ps_mass.json</code>.</li>
<li>The other expected output file
<code>intermediary_data/beta4.0/corr.ps_eff_mass.pdf</code> was found
but has now been removed by Snakemake.</li>
<li>Snakemake suggest this might be due to “filesystem latency”.</li>
</ol>
<p>This last point is a red herring. “Filesystem latency” is not an
issue here, and never will be, since we are not using a network
filesystem. We know what the problem is, as we deliberately caused it,
but to diagnose an unexpected error like this we would investigate
further by looking at the <code>intermediary_data/beta4.0</code>
subdirectory.</p>
<pre class="shellsession"><code>$ ls intermediary_data/beta4.0/
TODO</code></pre>
<p>Remember that Snakemake itself does not create any output files. It
just runs the commands you put in the <code>shell</code> sections, then
checks to see if all the expected output files have appeared.</p>
<p>So if the file names created by your rule are not exactly the same as
in the <code>output:</code> block you will get this error, and you will,
in this case, find that some output files are present but others
(<code>corr.ps_eff_mass.pdf</code>, which was named correctly) have been
cleaned up by Snakemake.</p>
<div id="errors-are-normal" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="errors-are-normal" class="callout-inner">
<h3 class="callout-title">Errors are normal</h3>
<div class="callout-content">
<p>Don’t be disheartened if you see errors like the one above when first
testing your new Snakemake workflows. There is a lot that can go wrong
when writing a new workflow, and you’ll normally need several iterations
to get things just right. One advantage of the Snakemake approach
compared to regular scripts is that Snakemake fails fast when there is a
problem, rather than ploughing on and potentially running junk
calculations on partial or corrupted data. Another advantage is that
when a step fails we can safely resume from where we left off, as we’ll
see in the next episode.</p>
</div>
</div>
</div>
<p>Finally, edit the names in the Snakefile back to the correct version
and re-run to confirm that all is well.</p>
<pre class="snakemake"><code>snakemake --jobs 1 --forceall --printshellcmds --use-conda assets/plots/spectrum.pdf</code></pre>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-dag"><p>Content from <a href="dag.html">How Snakemake plans jobs</a></p>
<hr>
<p>Last updated on 2025-05-20 |

        <a href="https://github.com/edbennett/snakemake-novice-lattice/edit/main/episodes/dag.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I visualise a Snakemake workflow?</li>
<li>How does Snakemake avoid unecessary work?</li>
<li>How do I control what steps will be run?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>View the DAG for our pipeline</li>
<li>Understand the logic Snakemake uses when running and re-running
jobs</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="the-dag">The DAG<a class="anchor" aria-label="anchor" href="#the-dag"></a>
</h2>
<hr class="half-width">
<p>You may have noticed that one of the messages Snakemake always prints
is:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Building DAG of jobs...</code></pre>
</div>
<p>A DAG is a <strong>Directed Acyclic Graph</strong> and it can be
pictured like so:</p>
<figure><img src="fig/dag_1.svg%20%7Balt='" alt="TODO" class="figure mx-auto d-block"><div class="figcaption">TODO</div>
</figure><p>The above DAG is based on three of our existing rules, and shows all
the jobs Snakemake would run to compute the pseudoscalar decay constant
of the <span class="math inline">\(\beta = 4.0\)</span> ensemble.</p>
<div id="note-that" class="callout checklist">
<div class="callout-square">
<i class="callout-icon" data-feather="check-square"></i>
</div>
<div id="note-that" class="callout-inner">
<h3 class="callout-title">Note that:</h3>
<div class="callout-content">
<ul>
<li>A rule can appear more than once, with different wildcards (a
<strong>rule</strong> plus <strong>wildcard values</strong> defines a
<strong>job</strong>)</li>
<li>A rule may not be used at all, if it is not required for the target
outputs</li>
<li>The arrows show dependency ordering between jobs</li>
<li>Snakemake can run the jobs in any order that doesn’t break
dependency. For example, <em>one_loop_matching</em> cannot run until
both <em>ps_mass</em> and <em>avg_plaquette</em> have completed, but it
may run before or after <em>count_trajectories</em>
</li>
<li>This is a work list, <em>not a flowchart</em>, so there are no
if/else decisions or loops. Snakemake runs every job in the DAG exactly
once</li>
<li>The DAG depends both on the Snakefile <em>and</em> on the requested
target outputs, and the files already present</li>
<li>When building the DAG, Snakemake does not look at the <em>shell</em>
part of the rules at all. Only when running the DAG will Snakemake check
that the shell commands are working and producing the expected output
files</li>
</ul>
</div>
</div>
</div>
<div id="how-many-jobs" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="how-many-jobs" class="callout-inner">
<h3 class="callout-title">How many jobs?</h3>
<div class="callout-content">
<p>If we asked Snakemake to run <code>one_loop_matching</code> on all
twelve ensembles (<code>beta2.0</code> to <code>beta10.0</code>), how
many jobs would that be in total?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>36 in total:</p>
<ul>
<li>12 <span class="math inline">\(\times\)</span>
<code>one_loop_matching</code>
</li>
<li>12 <span class="math inline">\(\times\)</span>
<code>ps_mass</code>
</li>
<li>12 <span class="math inline">\(\times\)</span>
<code>avg_plaquette</code>
</li>
<li>0 <span class="math inline">\(\times\)</span>
<code>count_trajectories</code>
</li>
</ul>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="snakemake-is-lazy-and-laziness-is-good">Snakemake is lazy, and laziness is good<a class="anchor" aria-label="anchor" href="#snakemake-is-lazy-and-laziness-is-good"></a>
</h2>
<hr class="half-width">
<p>For the last few episodes, we’ve told you to run Snakemake like
this:</p>
<pre class="shellsession"><code>snakemake --jobs 1 --forceall --printshellcmds --use-conda </code></pre>
<p>As a reminder, the <code>--jobs 1</code> flag tells Snakemake to run
one job at a time, <code>--printshellcmds</code> is to print out the
shell commands before running them, and <code>--use-conda</code> to
ensure that Snakemake sets up the correct Conda environment.</p>
<p>The <code>--forceall</code> flag turns on <code>forceall</code> mode,
and in normal usage you don’t want this.</p>
<p>At the end of the last chapter, we generated a spectrum plot by
running:</p>
<pre class="shellsession"><code>snakemake --jobs 1 --forceall --printshellcmds --use-conda assets/plots/spectrum.pdf</code></pre>
<p>Now try without the <code>--forceall</code> option. Assuming that the
output files are already created, you’ll see this:</p>
<pre class="shellsession"><code>$ snakemake --jobs 1 --forceall --printshellcmds --use-conda assets/plots/spectrum.pdf
TODO</code></pre>
<p>In normal operation, Snakemake only runs a job if:</p>
<ol style="list-style-type: decimal">
<li>A target file you explicitly requested to make is missing,</li>
<li>An intermediate file is missing and it is needed in the process of
making a target file,</li>
<li>Snakemake can see an input file which is newer than an output file,
or</li>
<li>A rule definition or configuration has changed since the output file
was created.</li>
</ol>
<p>The last of these relies on a ledger that Snakemake saves into the
<code>.snakemake</code> directory.</p>
<p>Let’s demonstrate each of these in turn, by altering some files and
re-running Snakemake without the <code>--forceall</code> option.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">$</span> rm assets/plots/spectrum.pdf</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="ex">$</span> snakemake <span class="at">--jobs</span> 1 <span class="at">--printshellcmds</span> <span class="at">--use-conda</span> assets/plots/spectrum.pdf</span></code></pre>
</div>
<p>This just re-runs <code>spectrum</code>, the final step.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">$</span> rm intermediary_data/beta<span class="pp">*</span>/corr.ps_mass.json</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="ex">$</span> snakemake <span class="at">--jobs</span> 1 <span class="at">--printshellcmds</span> <span class="at">--use-conda</span> assets/plots/spectrum.pdf</span></code></pre>
</div>
<p>“Nothing to be done”. Some intermediate output is missing, but
Snakemake already has the file you are telling it to make, so it doesn’t
worry.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">touch</span> raw_data/beta<span class="pp">*</span>/out_pg</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--jobs</span> 1 <span class="at">--printshellcmds</span> <span class="at">--use-conda</span> assets/plots/spectrum.pdf</span></code></pre>
</div>
<p>The <code>touch</code> command is a standard Unix command that resets
the timestamp of the file, so now the correlators look to Snakemake as
if they were just modified.</p>
<p>Snakemake sees that some of the input files used in the process of
producing <code>assets/plots/spectrum.pdf</code> are newer than the
existing output file, so it needs to run the <code>avg_plaquette</code>
and <code>one_loop_matching</code> steps again. Of course, the
<code>one_loop_matching</code> step needs the pseudoscalar mass data
that we deleted earlier, so now the correlation function fitting step is
re-run also.</p>
</section><section><h2 class="section-heading" id="explicitly-telling-snakemake-what-to-re-run">Explicitly telling Snakemake what to re-run<a class="anchor" aria-label="anchor" href="#explicitly-telling-snakemake-what-to-re-run"></a>
</h2>
<hr class="half-width">
<p>The default timestamp-based logic is really useful when you want
to:</p>
<ol style="list-style-type: decimal">
<li>Change or add some inputs to an existing analysis without
re-processing everything</li>
<li>Continue running a workflow that failed part-way</li>
</ol>
<p>In most cases you can also rely on Snakemake to detect when you have
edited a rule, but sometimes you need to be explicit, for example if you
have updated an external script or changed a setting that Snakemake
doesn’t see.</p>
<p>The <code>--forcerun</code> flag allows you to explicitly tell
Snakemake that a rule has changed and that all outputs from that rule
need to be re-evaluated.</p>
<pre class="shellsession"><code>snakemake  --forcerun spectrum --jobs 1--printshellcmds --use-conda assets/plots/spectrum.pdf</code></pre>
<div id="note-on---forcerun" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="note-on---forcerun" class="callout-inner">
<h3 class="callout-title">Note on <code>--forcerun</code>
</h3>
<div class="callout-content">
<p>Due to a quirk of the way Snakemake parses command-line options, you
need to make sure there are options after the
<code>--forcerun ...</code>, before the list of target outputs. If you
don’t do this, Snakemake will think that the target files are instead
items to add to the <code>--forcerun</code> list, and then when building
the DAG it will just try to run the default rule.</p>
<p>The easiest way is to put the <code>--jobs</code> flag before the
target outputs. Then you can list multiple rules to re-run, and also
multiple targets, and Snakemake can tell which is which.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--forcerun</span> avg_plaquette ps_mass <span class="at">--jobs</span> 1 <span class="at">--printshellcmds</span> <span class="at">--use-conda</span> intermediary_data/beta4.0/pg.corr.ps_decay_const.json intermediary_data/beta4.5/pg.corr.ps_decay_const.json</span></code></pre>
</div>
<p>The reason for using the <code>--jobs</code> flag specifically is
that you pretty much always want this option.</p>
</div>
</div>
</div>
<p>The <code>--force</code> flag specifies that the target outputs named
on the command line should always be regenerated, so you can use this to
explicitly re-make specific files.</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="ex">$</span> snakemake <span class="at">--jobs</span> 1 <span class="at">--force</span> <span class="at">--printshellcmds</span> assets/plots/spectrum.pdf</span></code></pre>
</div>
<p>This always re-runs <code>spectrum</code>, regardless of whether the
output file is there already. For all intermediate outputs, Snakemake
applies the default timestamp-based logic. Contrast with
<code>--forceall</code>, which runs the entire DAG every time.</p>
</section><section><h2 class="section-heading" id="visualising-the-dag">Visualising the DAG<a class="anchor" aria-label="anchor" href="#visualising-the-dag"></a>
</h2>
<hr class="half-width">
<p>Snakemake can draw a picture of the DAG for you, if you run it like
this:</p>
<pre class="shellsession"><code>snakemake --force --dag assets/plots/spectrum.pdf | gm display -</code></pre>
<p>Using the <code>--dag</code> option implicitly activates the
<code>--dry-run</code> option so that Snakemake will not actually run
any jobs, it will just print the DAG and stop. Snakemake prints the DAG
in a text format, so we use the <code>gm</code> command to make this
into a picture and show it on the screen.</p>
<div id="note-on-gm-display" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="note-on-gm-display" class="callout-inner">
<h3 class="callout-title">Note on <code>gm display</code>
</h3>
<div class="callout-content">
<p>The <code>gm</code> command is provided by the <a href="https://www.graphicsmagick.org/" class="external-link">GraphicsMagick toolkit</a>. On
systems where <code>gm</code> will not display an image directly, you
can instead save it to a PNG file. You will need the <code>dot</code>
program from the <a href="https://graphviz.org/" class="external-link">GraphViz package</a>
installed.</p>
<pre class="shellsession"><code>snakemake --force --dag assets/plots/spectrum.pdf | dot -Tpng &gt; dag.png</code></pre>
</div>
</div>
</div>
<p>![TODO][fig-dag2]</p>
<p>The boxes drawn with dotted lines indicate steps that are not to be
run, as the output files are already present and newer than the input
files.</p>
<div id="visualising-the-effect-of-the---forcerun-and---force-flags" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="visualising-the-effect-of-the---forcerun-and---force-flags" class="callout-inner">
<h3 class="callout-title">Visualising the effect of the
<code>--forcerun</code> and <code>--force</code> flags</h3>
<div class="callout-content">
<p>Run <code>one_loop_matching</code> on the <code>beta4.0</code>
ensemble, and then use the <code>--dag</code> option as shown above to
check:</p>
<ol style="list-style-type: decimal">
<li><p>How many jobs will run if you ask again to create this output
with no <code>--force</code>, <code>--forcerun</code> or
<code>-forceall</code> options?</p></li>
<li><p>How many if you use the <code>--force</code> option?</p></li>
<li><p>How many if you use the <code>--forcerun ps_mass</code>
option?</p></li>
<li><p>How many if you edit the metadata file so that the
<code>ps_plateau_start</code> for the <span class="math inline">\(\beta=4.0\)</span> ensemble is <code>TODO</code>,
rather than <code>TODO</code>?</p></li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p>This is a way to make the result in the first place:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="ex">$</span> snakemake <span class="at">--jobs</span> 1 <span class="at">--printshellcmds</span> intermediary_data/beta4.0/pg.corr.ps_decay_const.json</span></code></pre>
</div>
<ol style="list-style-type: decimal">
<li>This command should show three boxes, but all are dotted so no jobs
are actually to be run.</li>
</ol>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="ex">$</span> snakemake <span class="at">--dag</span> intermediary_data/beta4.0/pg.corr.ps_decay_const.json <span class="kw">|</span> <span class="ex">gm</span> display <span class="at">-</span></span></code></pre>
</div>
<ol start="2" style="list-style-type: decimal">
<li><p>The <code>--force</code> flag re-runs only the job to create the
output file, so in this case one box is solid, and only that job will
run.</p></li>
<li>
<p>With <code>--forcerun ps_mass</code>, the <code>ps_mass</code>
job will re-run, and Snakemake sees that this also requires re-running
<code>one_loop_matching</code>, so the answer is 2.</p>
<p>If you see a message like the one below, it’s because you need to put
an option after <code>ps_mass</code> or else Snakemake gets confused
about what are parameters of <code>--forcerun</code>, and what things
are targets.</p>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>WorkflowError:
Target rules may not contain wildcards.</code></pre>
</div>
</li>
<li><p>Editing the Snakefile has the same effect as forcing the
<code>ps_mass</code> rule to re-run, so again there will be two jobs to
be run from the DAG.</p></li>
</ol>
<p>With older versions of Snakemake this would not be auto-detected, and
in fact you can see this behaviour if you remove the hidden
<code>.snakemake</code> directory. Now Snakemake has no memory of the
rule change so it will not re-run any jobs unless explicitly told
to.</p>
</div>
</div>
</div>
</div>
<div id="removing-files-to-trigger-reprocessing" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="removing-files-to-trigger-reprocessing" class="callout-inner">
<h3 class="callout-title">Removing files to trigger reprocessing</h3>
<div class="callout-content">
<p>In general, getting Snakemake to re-run things by removing files is a
bad idea, because it’s easy to forget about intermediate files that
actually contain stale results and need to be updated. Using the
<code>--forceall</code> flag is simpler and more reliable. If in doubt,
and if it will not be too time consuming, keep it simple and just use
<code>--forceall</code> to run the whole workflow from scratch.</p>
<p>For the opposite case where you want to avoid re-running particular
steps, see the <code>‑‑touch</code> option of Snakemake mentioned <a href="TODO">later in the lesson</a>.</p>
</div>
</div>
</div>
<p>TODO Diagram showing jobs as coloured boxes joined by arrows
representing data flow. The box labelled as kallisto_index is in green
at the top, with two blue boxes labelled trimreads and two yellow boxes
labelled countreads. The blue trimreads boxes have arrows into the
respective yellow countreads boxes. Finally there is a kallisto_quant
job shown as a red box, with incoming arrows from both the trimreads box
as well as the kallisto_index box.’ } [fig-dag2]: fig/dag_2.png {alt=’
TODO A DAG for the partial workflow with four boxes, representing two
trimreads jobs and a kallisto_index job, then a kallisto_quant job
receiving input from the previous three. The boxes for the
kallisto_index and trimreads jobs are dotted, but the kallisto_quant box
is solid.’}</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>A <strong>job</strong> in Snakemake is a <strong>rule</strong> plus
<strong>wildcard values</strong> (determined by working back from the
requested output)</li>
<li>Snakemake plans its work by arranging all the jobs into a
<strong>DAG</strong> (directed acyclic graph)</li>
<li>If output files already exist, Snakemake can skip parts of the
DAG</li>
<li>Snakemake compares file timestamps and a log of previous runs to
determine what need regenerating</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-optimisation"><p>Content from <a href="optimisation.html">Optimising workflow performance</a></p>
<hr>
<p>Last updated on 2025-05-20 |

        <a href="https://github.com/edbennett/snakemake-novice-lattice/edit/main/episodes/optimisation.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What compute resources are available on my system?</li>
<li>How do I define jobs with more than one thread?</li>
<li>How do I measure the compute resources being used by a
workflow?</li>
<li>How do I run my workflow steps in parallel?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Understand CPU, RAM and I/O bottlenecks</li>
<li>Understand the <code>threads</code> declaration</li>
<li>Use common Unix tools to look at resource usage</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="processes-threads-and-processors">Processes, threads and processors<a class="anchor" aria-label="anchor" href="#processes-threads-and-processors"></a>
</h2>
<hr class="half-width">
<p>Some definitions:</p>
<ul>
<li>
<strong>Process</strong>: A running program (in our case, each
Snakemake job can be considered one process)</li>
<li>
<strong>Threads</strong>: Each process has one or more threads which
run in parallel</li>
<li>
<strong>Processor</strong>: Your computer has multiple <em>CPU
cores</em> or processors, each of which can run one thread at a
time</li>
</ul>
<p>These definitions are a little simplified, but fine for our needs.
The operating system kernel shares out threads among processors:</p>
<ul>
<li>Having <em>fewer threads</em> than <em>processors</em> means you are
not fully using all your CPU cores</li>
<li>Having <em>more threads</em> than <em>processors</em> means threads
have to “timeslice” on a core which is generally suboptimal</li>
</ul>
<p>If you tell Snakemake how many threads each rule will use, and how
many cores you have available, it will start jobs in parallel to use all
your cores. In the diagram below, five jobs are ready to run and there
are four system cores.</p>
<figure><img src="fig/snake_threads.svg%20%7Balt='" class="figure mx-auto d-block"></figure></section><section><h2 class="section-heading" id="listing-the-resources-of-your-machine">Listing the resources of your machine<a class="anchor" aria-label="anchor" href="#listing-the-resources-of-your-machine"></a>
</h2>
<hr class="half-width">
<p>So, to know how many threads to make available to Snakemake, we need
to know how many CPU cores we have on our machine. On Linux, we can find
out how many cores you have on a machine with the <code>lscpu</code>
command.</p>
<pre class="shellsession"><code>$ lscpu
Architecture:             aarch64
  CPU op-mode(s):         32-bit, 64-bit
  Byte Order:             Little Endian
CPU(s):                   4
  On-line CPU(s) list:    0-3
Vendor ID:                ARM
  Model name:             Cortex-A72
    Model:                3
    Thread(s) per core:   1</code></pre>
<p>There we can see that we have four CPU cores, each of which can run a
single thread.</p>
<p>On macOS meanwhile, we use the command
<code>sysctl -n hw.ncpu</code>:</p>
<pre class="shellsession"><code>$ sysctl hw.ncpu
hw.ncpu: 8</code></pre>
<p>In this case, we see that this Mac has eight cores.</p>
<p>Likewise find out the amount of RAM available:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">$</span> free <span class="at">-h</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>               <span class="ex">total</span>        used        free      shared  buff/cache   available</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="ex">Mem:</span>           3.7Gi       1.1Gi       110Mi        97Mi       2.6Gi       2.6Gi</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="ex">Swap:</span>          199Mi       199Mi        60Ki</span></code></pre>
</div>
<p>In this case, the machine has 3.7GiB of total RAM.</p>
<p>On macOS, the command is sysctl <code>hw.memsize</code>:</p>
<pre class="shellsession"><code>$ sysctl hw.memsize
hw.memsize: 34359738368</code></pre>
<p>This machine has 34,359,738,368 bytes of RAM in total. Dividing by
the number of bytes in 1GiB (<span class="math inline">\(1024^3\)</span>
bytes), that becomes 32GiB RAM.</p>
<p>We don’t want to use all of this RAM, but if we don’t mind other
applications being unresponsive while our workflow runs, we can use the
majority of it.</p>
<p>Finally, to check the available disk space, on the current
partition:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">$</span> df <span class="at">-h</span> .</span></code></pre>
</div>
<p>(or <code>df -h</code> without the <code>.</code> to show all
partitions) This is the same on both macOS and Linux.</p>
</section><section><h2 class="section-heading" id="parallel-jobs-in-snakemake">Parallel jobs in Snakemake<a class="anchor" aria-label="anchor" href="#parallel-jobs-in-snakemake"></a>
</h2>
<hr class="half-width">
<p>You may want to see the relevant part of <a href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#threads" class="external-link">the
Snakemake documentation</a>.</p>
<p>We’ll force all the intermediary steps to re-run by using the
<code>--forceall</code> flag to Snakemake and time the whole run using
the <code>time</code> command.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">$</span> time snakemake <span class="at">--jobs</span> 1 <span class="at">--forceall</span> <span class="at">--</span> assets/plots/spectrum.pdf</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="ex">TODO</span> TIME</span></code></pre>
</div>
<div id="measuring-how-concurrency-affects-execution-time" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="measuring-how-concurrency-affects-execution-time" class="callout-inner">
<h3 class="callout-title">Measuring how concurrency affects execution time</h3>
<div class="callout-content">
<p>What is the <em>wallclock time</em> reported by the above command?
We’ll work out the average for everyone present, or if you are working
through the material on your own, repeat the measurement three times to
get your own average.</p>
<p>Now change the Snakemake concurrency option to <code>--jobs 2</code>
and then <code>--jobs 4</code>.</p>
<ul>
<li>How does the total execution time change?</li>
<li>What factors do you think limit the power of this setting to reduce
the execution time?</li>
</ul>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>The time will vary depending on the system configuration but
somewhere around TODO seconds is expected, and this should reduce to
around TODO secs with <code>--jobs 2</code> but higher
<code>--jobs</code> will produce diminishing returns.</p>
<p>Things that may limit the effectiveness of parallel execution
include:</p>
<ul>
<li>The number of processors in the machine</li>
<li>The number of jobs in the DAG which are independent and can
therefore be run in parallel</li>
<li>The existence of single long-running jobs</li>
<li>The amount of RAM in the machine</li>
<li>The speed at which data can be read from and written to disk</li>
</ul>
</div>
</div>
</div>
</div>
<p>There are <strong>a few gotchas</strong> to bear in mind when using
parallel execution:</p>
<ol style="list-style-type: decimal">
<li>Parallel jobs will use more RAM. If you run out then either your OS
will swap data to disk, or a process will crash.</li>
<li>Parallel jobs may trip over each other if they try to write to the
same filename at the same time (this can happen with temporary
files).</li>
<li>The on-screen output from parallel jobs will be jumbled, so save any
output to log files instead.</li>
</ol></section><section><h2 class="section-heading" id="multi-thread-rules-in-snakemake">Multi-thread rules in Snakemake<a class="anchor" aria-label="anchor" href="#multi-thread-rules-in-snakemake"></a>
</h2>
<hr class="half-width">
<p>In the diagram at the top, we showed jobs with 2 and 8 threads. These
are defined by adding a <code>threads:</code> block to the rule
definition. We could do this for the <code>ps_mass</code> rule:</p>
<pre class="source"><code>rule ps_mass:
    input:
        data="raw_data/beta{beta}/out_corr",
    output:
        data="intermediary_data/beta{beta}/corr.ps_mass.json.gz",
        plot="intermediary_data/beta{beta}/corr.ps_eff_mass.{plot_filetype}",
    log:
        messages="intermediary_data/beta{beta}/corr.ps_mass.log",
    params:
        plateau_start: lookup(within=metadata, query="beta = {beta}", cols="ps_plateau_start"),
        plateau_end: lookup(within=metadata, query="beta = {beta}", cols="ps_plateau_end"),
    conda: "envs/analysis.yml"
    threads: 4
    shell:
        "python -m su2pg_analysis.meson_mass {input.data} --output_file {output.data} --plateau_start {params.plateau_start} --plateau_end {params.plateau_end} --plot_file {output.plot} --plot_styles {plot_styles} |&amp; tee {log.messages}"</code></pre>
<p>You should explicitly use <code>threads: 4</code> rather than
<code>params: threads = "4"</code> because Snakemake considers the
number of threads when scheduling jobs. Also, if the number of threads
requested for a rule is less than the number of available processors
then Snakemake will use the lower number.</p>
<p>Snakemake uses the <code>threads</code> variable to set common
environment variables like <code>OMP_NUM_THREADS</code>. If you need to
pass the number explicitly to your program, you can use the
<code>{threads}</code> placeholder to get it.</p>
<div id="fine-grained-profiling" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="fine-grained-profiling" class="callout-inner">
<h3 class="callout-title">Fine-grained profiling</h3>
<div class="callout-content">
<p>Rather than timing the entire workflow, we can ask Snakemake to
benchmark an individual rule.</p>
<p>For example, to benchmark the <code>ps_mass</code> step we could add
this to the rule definition:</p>
<pre class="source"><code>rule ps_mass:
    benchmark:
        "benchmarks/ps_mass.beta{beta}.txt"
    ...</code></pre>
<p>The dataset here is so small that the numbers are tiny, but for real
data this can be very useful as it shows time, memory usage and IO load
for all jobs.</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="running-jobs-on-a-cluster">Running jobs on a cluster<a class="anchor" aria-label="anchor" href="#running-jobs-on-a-cluster"></a>
</h2>
<hr class="half-width">
<p>Learning about clusters is beyond the scope of this course, but can
be essential for more complex workflows working with large amounts of
data.</p>
<p>When working with Snakemake, there are two options to getting the
workflow running on a cluster:</p>
<ol style="list-style-type: decimal">
<li><p>Similarly to most tools, we may install Snakemake on the cluster,
write a job script, and execute Snakemake on our workflow inside a
job.</p></li>
<li><p>We can teach Snakemake how to run jobs on the cluster, and run
our workflow from our own computer, having Snakemake do the work of
submitting and monitoring the jobs for us.</p></li>
</ol>
<p>To run Snakemake in the second way, someone will need to determine
the right parameters for your particular cluster and save them as a
profile. Once this is working, you can share the profile with other
users on the cluster, so discuss this with your cluster sysadmin.</p>
<p>Instructions for configuring the Slurm executor plugin can be found
in the <a href="https://snakemake.github.io/snakemake-plugin-catalog/" class="external-link">Snakemake
plugin catalog</a>, along with the <code>drmaa</code>,
<code>cluster-generic</code> and <code>cluster-sync</code> plugins which
can support PBS, SGE and other cluster schedulers.</p>
<p>![][fig-cluster]</p>

<div id="cluster-demo" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="cluster-demo" class="callout-inner">
<h3 class="callout-title">Cluster demo</h3>
<div class="callout-content">
<p>A this point in the course there may be a cluster demo…</p>
</div>
</div>
</div>
<p>Representation of a computer with four microchip icons indicating
four available cores. To the right are five small green boxes
representing Snakemake jobs and labelled as wanting 1, 1, 1, 2 and 8
threads respectively. ‘} [fig-cluster]: fig/cluster.jpg {alt=’ A photo
of some high performance computer hardware racked in five cabinets in a
server room. Each cabinet is about 2.2 metres high and 0.8m wide. The
doors of the cabinets are open to show the systems inside. Orange and
yellow cabling is prominent, connecting ports within the second and
third racks. ’}</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>To make your workflow run as fast as possible, try to match the
number of threads to the number of cores you have</li>
<li>You also need to consider RAM, disk, and network bottlenecks</li>
<li>Profile your jobs to see what is taking most resources</li>
<li>Snakemake is great for running workflows on compute clusters</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/edbennett/snakemake-novice-lattice/edit/main/README.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/edbennett/snakemake-novice-lattice/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/edbennett/snakemake-novice-lattice/" class="external-link">Source</a></p>
				<p><a href="https://github.com/edbennett/snakemake-novice-lattice/blob/main/CITATION.cff" class="external-link">Cite</a> | <a href="mailto:e.j.bennett@swansea.ac.uk">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.12" class="external-link">sandpaper (0.16.12)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.9" class="external-link">pegboard (0.7.9)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.6" class="external-link">varnish (1.0.6)</a></p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "LearningResource",
  "@id": "https://edbennett.github.io/snakemake-novice-lattice/aio.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/LearningResource/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries, snakemake, lattice quantum field theory",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://edbennett.github.io/snakemake-novice-lattice/aio.html",
  "identifier": "https://edbennett.github.io/snakemake-novice-lattice/aio.html",
  "dateCreated": "2025-01-03",
  "dateModified": "2025-05-27",
  "datePublished": "2025-05-27"
}

  </script><script>
		feather.replace();
	</script>
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

